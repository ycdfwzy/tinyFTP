# FTP文档

***软件62  2016013258  王泽宇***

## UDP

UDP部分，服务端修改发回的消息即可。

```c
total_message++;	// 消息数+1
sprintf(bufout, "%d %s", total_message, bufin); // 构造发回的消息
send_back(sd, bufout)	// 向客户端发送消息
```

客户端只需要将在发消息的逻辑外加上一层循环，将0～50发送给服务器即可

两个问题的回答见第一阶段的文档。



## FTP

### Server

在`server`文件夹下，用`make server`命令生成server的可执行文件。

`./server`运行server（可能需要管理员权限），可以在后加两个参数：`-port`表示指定server监听的端口号（默认端口为`21`）;`-root`表示服务器的根目录（默认目录为`tmp`），客户端只可以访问这个根目录以及根目录的子目录，否则服务器会拒绝访问。

Server实现了以下的命令：

* `USER`，`PASS`，用于提供登录的功能。
* `QUIT`，`ABOR`，用于提供登出功能。
* `SYST`，获取服务器信息。
* `TYPE`，用于在传输文件之前指定文件传输格式，只支持Binary模式。
* `MKD`，`RMD`，用于创建/删除文件夹。
* `DELE`，用于删除文件。
* `PWD`，查询该连接的当前目录
* `CWD`，更改该连接的当前目录。
* `RNFR`，`RNTO`，重命名。
* `PORT`，`PASV`，选择数据传输模式
* `STOR`，上传文件
* `RETR`，下载文件
* `REST`，用于在`STOR`和`REST`命令之前，指定文件传输的偏移量，用于实现断点传输。

Server用多线程实现多客户连接，借用`REST`命令实现断点续传功能。

### Client

Client用在`Ubuntu 18.04`下用Qt5.11.2实现，复用了部分服务端的代码。

使用方法见客户端说明。

#### 功能封装

* 登录：依次发送`USER`和`PASS`命令，从服务器返回消息判断是否登录成功。
* 删除：判断需要删除的是文件或是文件夹，如果是文件，发送`DELE`命令，如果是文件夹，发送`RMD`命令
* 获取文件列表：依次发送`TYPE`,`PASV`,`LIST`命令，并从发回的类表中抽取出文件信息。
* 当前目录切换（包括地址栏输入、返回上一级、进入子目录）：不同任务需求计算算出目标地址，发送`CWD`命令，并获取文件列表。
* 重命名：依次发送`RNFR`，`RNTO`命令。
* （断点）上传文件：依次发送`TYPE`，`PASV`，`REST`，`STOR`指令，在传送结束或者被使用者中止后切断数据连接。
* （断点）下载文件：依次发送`TYPE`，`PASV`，`REST`，`RETR`指令，在传送结束或者被使用者中止后切断数据连接。

#### 断点续传

可以在任何文件传输（上传/下载）过程中点击暂停按钮，这样客户端就会断开和程序数据连接，并存下已上传/下载的进度，便于续传的时候使用。

#### 大文件传输不阻塞

客户端的响应和文件传输的异步的，大文件传输不会阻塞GUI的响应，如果文件传输过程中客户端有交互式见，GUI会提示“文件传输过程中不能进行其他操作”。客户可以先暂停文件传输、进行操作，之后在进行文件传输。



## 总结

这次FTP实验我用Linux C实现了一个客户端，在实现过程中仔细学习了FTP的协议内容和部分Linux的系统调用。在学习了网路协议的同时，也学习了Linux C的编程魅力。

### 遇到的一些困难

* 建立数据连接后，连接可能随时到来？

  解决：为了不阻塞主程，将数据连接转移到新的子线程中。

* 多用户连接时，服务端的管理复杂

  解决：在服务端将每个连接的信息存在一个结构中，词结构包括客户端当前所出的路径、文件传输的偏移量、数据传输连接等信息，方便维护管理。

* 客户端传输文件暂停后，更换文件夹，续传会出错

  解决：传输命令改为绝对路径。

* 客户端界面中通过右键菜单下载文件，中途再次建立一个右键菜单会导致程崩溃。

  解决：再次右键一个菜单后，会销毁原来的右键菜单，导致下载后的子进程无法正确结束，故程序

崩溃。为了避免这种情况，不再销毁原来的右键菜单。